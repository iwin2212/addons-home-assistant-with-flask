<!DOCTYPE html>
<html lang="en">

    <head>
        <title>Add Scripts</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="./static/css/bootstrap.min.css">
        <link rel="stylesheet" href="./static/css/style.css">
        <script src="./static/js/jquery.min.js"></script>
        <script src="./static/js/popper.min.js"></script>
        <script src="./static/js/bootstrap.min.js"></script>
        <script src="./static/js/validate.js"></script>
        <script src="./static/js/automation.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>

    </head>

    <body onload="check_action()">
        {%include 'head_foot/header.html'%}
        <section id='main'>
            <div class="container">
                <h3 id='title'>Sửa kịch bản</h3>
                <h5 style="float: right"><a target="_blank" rel="noopener noreferrer" href="http://addscript.javisco.vn/">Hướng dẫn</a></h5>
                <div class="container">
                    <form action='./add_scripts_recall_edit?id_item={{id_item}}' method='POST'>
                        <table class="table table_striped table-borderless container-fluid">
                            <tr id='entity_script'>
                                <td colspan='2'>
                                    <table class='container-fluid table-borderless'>
                                        <tr>
                                            <td width='30%'><strong>Tên kịch bản</strong></td>
                                            <td width='70%'><input type='text' name='ten' class='form-control'
                                                    placeholder="Ví dụ: Mở 3 đèn phòng khách" required
                                                    value="{{scripts['alias']}}">
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            {%for i in scripts['sequence']%}
                            <tr id="entity_action_id_{{loop.index-1}}"
                                onmouseenter='show_change_pos_btn({{loop.index-1}})'
                                onmouseleave='hide_change_pos_btn({{loop.index-1}})'>
                                <td colspan='2'>
                                    <table id='block_{{loop.index-1}}' class='container-fluid table-borderless'>
                                        <tr>
                                            <td width='30%'>Chọn hành động</td>
                                            <td width="70%">
                                                <select name='action' class='form-control selectpicker container-fluid'
                                                    data-dropup-auto="false" data-size="7" data-live-search="true"
                                                    onchange='changeActionContent({{loop.index-1}}, this)'
                                                    id="hanhdong_{{loop.index-1}}">
                                                    <option value='switch.turn_on' {% if i['service']=='switch.turn_on'
                                                        %} selected {% endif %}>
                                                        Công tắc: Bật</option>
                                                    <option value='switch.turn_off' {% if
                                                        i['service']=='switch.turn_off' %} selected {% endif %}>
                                                        Công
                                                        tắc: Tắt</option>
                                                    <option value='climate.turn_off' {% if
                                                        i['service']=='climate.turn_off' %} selected {% endif %}>
                                                        Điều hoà: Tắt điều hoà</option>
                                                    <option value='climate.set_temperature' {% if
                                                        i['service']=='climate.set_temperature' %} selected {% endif %}>
                                                        Điều
                                                        hoà: Bật nhiệt độ</option>
                                                    <option value='climate.set_fan_mode' {% if
                                                        i['service']=='climate.set_fan_mode' %} selected {% endif %}>
                                                        Điều hoà: Bật chế độ gió</option>
                                                    <option value='media_player.media_play_pause' {% if
                                                        i['service']=='media_player.media_play_pause' %} selected {%
                                                        endif %}>
                                                        Điều khiển nhạc: Tạm dừng</option>
                                                    <option value='media_player.media_play' {% if
                                                        i['service']=='media_player.media_play' %} selected {% endif %}>
                                                        Điều
                                                        khiển nhạc: Tiếp tục</option>
                                                    <option value='media_player.media_stop' {% if
                                                        i['service']=='media_player.media_stop' %} selected {% endif %}>
                                                        Điều
                                                        khiển nhạc: Dừng</option>
                                                    <option value='media_player.media_pause' {% if
                                                        i['service']=='media_player.media_pause' %} selected {% endif
                                                        %}>Điều
                                                        khiển nhạc: Chơi tiếp</option>
                                                    <option value='media_player.volume_mute' {% if
                                                        i['service']=='media_player.volume_mute' %} selected {% endif
                                                        %}>Điều
                                                        khiển nhạc: Tắt tiếng</option>
                                                    <option value='media_player.volume_set' {% if
                                                        i['service']=='media_player.volume_set' %} selected {% endif %}>
                                                        Điều
                                                        khiển nhạc: Thiết lập âm lượng</option>
                                                    <option value='media_player.volume_up' {% if
                                                        i['service']=='media_player.volume_up' %} selected {% endif %}>
                                                        Điều
                                                        khiển nhạc: Tăng âm lượng</option>
                                                    <option value='media_player.volume_down' {% if
                                                        i['service']=='media_player.volume_down' %} selected {% endif
                                                        %}>Điều
                                                        khiển nhạc: Giảm âm lượng</option>
                                                    <option value='light.turn_on' {% if i.get('data') !=None %} {% if
                                                        i['service']=='light.turn_on' %} selected {% endif %} {% endif
                                                        %}>Đèn:
                                                        Bật</option>
                                                    <option value='light.turn_off' {% if i['service']=='light.turn_off'
                                                        %} selected {% endif %}>
                                                        Đèn: Tắt</option>
                                                    <option value='light.turn_on' {% if i.get('data') !=None %} {% if
                                                        i['data'].get('brightness_pct') !=None %} selected {% endif %}
                                                        {% endif %}>Đèn: Thiết lập độ sáng</option>
                                                    <option value='light.turn_on' {% if i.get('data') !=None %} {% if
                                                        i['data'].get('color_name') !=None %} selected {% endif %} {%
                                                        endif %}>
                                                        Đèn: Thiết lập màu</option>
                                                    <option value='light.turn_on' {% if i.get('data') !=None %} {% if
                                                        i['data'].get('profile') !=None %} selected {% endif %} {% endif
                                                        %}>Đèn:
                                                        Thiết lập chế độ</option>
                                                    <option value='lock.unlock' {% if i['service']=='lock.unlock' %}
                                                        selected {% endif %}>Khoá: Mở</option>
                                                    <option value='lock.lock' {% if i['service']=='lock.lock' %}
                                                        selected {% endif %}>
                                                        Khoá: Đóng</option>
                                                    <option value='media_player.speak' {% if
                                                        i['service']=='tts.google_translate_say' %} selected {% endif
                                                        %}>
                                                    </option>
                                                    Phát
                                                    giọng nói: Nhập nội dung Tiếng Việt</option>
                                                    <option value='fan.turn_on' {% if i['service']=='fan.turn_on' %}
                                                        selected {% endif %}>Quạt: Bật</option>
                                                    <option value='fan.turn_off' {% if i['service']=='fan.turn_off' %}
                                                        selected {% endif %}>Quạt: Tắt</option>
                                                    <option value='cover.open_cover' {% if
                                                        i['service']=='cover.open_cover' %} selected {% endif %}>
                                                        Rèm: Mở</option>
                                                    <option value='cover.close_cover' {% if
                                                        i['service']=='cover.close_cover' %} selected {% endif %}>
                                                        Rèm: Đóng</option>
                                                    <option value='cover.set_cover_position' {% if
                                                        i['service']=='cover.set_cover_position' %} selected {% endif
                                                        %}>Rèm: Mở
                                                        một phần</option>
                                                    <option value='cover.stop_cover' {% if
                                                        i['service']=='cover.stop_cover' %} selected {% endif %}>
                                                        Rèm: Tạm dừng</option>
                                                    <option value='media_player.turn_on' {% if
                                                        i['service']=='media_player.turn_on' %} selected {% endif %}>TV:
                                                        Bật</option>
                                                    <option value='media_player.turn_off' {% if
                                                        i['service']=='media_player.turn_off' %} selected {% endif %}>
                                                        TV: Tắt
                                                    </option>
                                                    <option value='media_player.select_source' {% if
                                                        i['service']=='media_player.select_source' %} selected {% endif
                                                        %}>TV:
                                                        Chọn đầu vào</option>
                                                    <option value='delay' {% if i.get('delay') !=None %} selected {%
                                                        endif %}>Thời
                                                        gian chờ</option>
                                                </select>
                                            </td>
                                        </tr>

                                        {% if i['service'] == 'climate.set_temperature' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'></td>
                                            <td width="70%">
                                                <table class='container-fluid '>
                                                    <tr>
                                                        <td>Mức gió</td>
                                                        <td name="mode"><select name="mode" class='form-control'>
                                                                <option {% if i['data']['hvac_mode']=='cool' %} selected
                                                                    {% endif %}>
                                                                    cool</option>
                                                                <option {% if i['data']['hvac_mode']=='heat' %} selected
                                                                    {% endif %}>
                                                                    heat</option>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Nhiệt độ</td>
                                                        <td name="temperature">
                                                            <select name="temperature" class='form-control'>
                                                                <option {% if i['data']['temperature']==18 %} selected
                                                                    {% endif %}>
                                                                    18</option>
                                                                <option {% if i['data']['temperature']==19 %} selected
                                                                    {% endif %}>
                                                                    19</option>
                                                                <option {% if i['data']['temperature']==20 %} selected
                                                                    {% endif %}>
                                                                    20</option>
                                                                <option {% if i['data']['temperature']==21 %} selected
                                                                    {% endif %}>
                                                                    21</option>
                                                                <option {% if i['data']['temperature']==22 %} selected
                                                                    {% endif %}>
                                                                    22</option>
                                                                <option {% if i['data']['temperature']==23 %} selected
                                                                    {% endif %}>
                                                                    23</option>
                                                                <option {% if i['data']['temperature']==24 %} selected
                                                                    {% endif %}>
                                                                    24</option>
                                                                <option {% if i['data']['temperature']==25 %} selected
                                                                    {% endif %}>
                                                                    25</option>
                                                                <option {% if i['data']['temperature']==26 %} selected
                                                                    {% endif %}>
                                                                    26</option>
                                                                <option {% if i['data']['temperature']==27 %} selected
                                                                    {% endif %}>
                                                                    27</option>
                                                                <option {% if i['data']['temperature']==28 %} selected
                                                                    {% endif %}>
                                                                    28</option>
                                                                <option {% if i['data']['temperature']==29 %} selected
                                                                    {% endif %}>
                                                                    29</option>
                                                                <option {% if i['data']['temperature']==30 %} selected
                                                                    {% endif %}>
                                                                    30</option>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                        {% endif %}

                                        {% if i['service'] == 'climate.set_fan_mode' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Chế độ</td>
                                            <td name="fan_mode" width="70%">
                                                <select name="fan_mode" class='form-control'>
                                                    <option {% if i['data']['fan_mode']=='low' %} selected {% endif %}>
                                                        low
                                                    </option>
                                                    <option {% if i['data']['fan_mode']=='medium' %} selected {% endif
                                                        %}>
                                                        medium
                                                    </option>
                                                    <option {% if i['data']['fan_mode']=='high' %} selected {% endif %}>
                                                        high</option>
                                                    <option {% if i['data']['fan_mode']=='auto' %} selected {% endif %}>
                                                        auto</option>
                                                </select>
                                            </td>
                                        </tr>
                                        {% endif %}

                                        {% if i['service'] == 'media_player.select_source' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Tên kênh</td>
                                            <td width="70%"><input type="text" class='form-control'
                                                    value="{{i['data']['source']}}" name='source' value=""
                                                    placeholder="Ví dụ: VTV1" requied></td>
                                        </tr>
                                        {% endif %}

                                        {% if i['service'] == 'tts.google_translate_say' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Lời nói</td>
                                            <td width="70%">
                                                <input type="text" name="message" value="{{i['data']['message']}}"
                                                    id="speak_{{loop.index-1}}" class="form-control" required />
                                            </td>
                                        </tr>
                                        {% endif %}

                                        {% if i['service'] == 'media_player.volume_set' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Chọn mức âm lượng</td>
                                            <td width="70%">
                                                <input type="number" name="volume" value="{{i['data']['volume_level']}}"
                                                    id="volume" min="0" max="100" placeholder='ví dụ: 50'
                                                    class="form-control" />
                                            </td>
                                        </tr>
                                        {% endif %}

                                        {% if i['service'] == 'lock.lock' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Mật khẩu</td>
                                            <td width="70%"><input type="text" class='form-control'
                                                    value="{{i['data']['code']}}" name='lock_code'
                                                    placeholder="Ví dụ: 1234" requied></td>
                                        </tr>
                                        {% endif %}

                                        {% if i['service'] == 'lock.unlock' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Mật khẩu</td>
                                            <td width="70%"><input type="text" class='form-control'
                                                    value="{{i['data']['code']}}" name='lock_code'
                                                    placeholder="Ví dụ: 1234" requied></td>
                                        </tr>
                                        {% endif %}

                                        {% if i['service'] == 'cover.set_cover_position' %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Chọn % mở</td>
                                            <td width="70%">
                                                <input type="number" name="pct_open" value="{{i['data']['position']}}"
                                                    id="pct_open" min="0" max="100" placeholder='ví dụ: 50'
                                                    class="form-control" />
                                            </td>
                                        </tr>
                                        {% endif %}

                                        {% if i.get('delay') != None %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Chọn khoảng thời gian</td>
                                            <td width="70%">
                                                <input type="text" value="{{i['delay']}}" name="delay"
                                                    class="datepicker form-control" autocomplete="off">
                                            </td>
                                        </tr>
                                        {% endif %}

                                        {% if i.get('data') != None %}
                                        {% if i['data'].get('brightness_pct') != None %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Chọn độ sáng (%)</td>
                                            <td width="70%">
                                                <input type="number" name="brightness_pct"
                                                    value="{{i['data']['brightness_pct']}}" min="0" max="100"
                                                    placeholder="ví dụ: 35" id="brightness_pct" class="form-control" />
                                            </td>
                                            <input name="brightness_pct_order" value='{{loop.index-1}}'
                                                style="display: none;" />
                                        </tr>
                                        {% endif %}
                                        {% if i['data'].get('color_name') != None %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Chọn màu</td>
                                            <td width="70%">
                                                <select name="color" class="form-control">
                                                    <option value='white' {% if i['data']['color_name']=='white' %}
                                                        selected {% endif %}>Màu trắng</option>
                                                    <option value='red' {% if i['data']['color_name']=='red' %} selected
                                                        {% endif %}>
                                                        Màu đỏ</option>
                                                    <option value='purple' {% if i['data']['color_name']=='purple' %}
                                                        selected {% endif %}>Màu tím</option>
                                                    <option value='green' {% if i['data']['color_name']=='green' %}
                                                        selected {% endif %}>Màu xanh lá cây</option>
                                                    <option value='yellow' {% if i['data']['color_name']=='yellow' %}
                                                        selected {% endif %}>Màu vàng</option>
                                                    <option value='blue' {% if i['data']['color_name']=='blue' %}
                                                        selected {% endif %}>Màu xanh dương</option>
                                                    <option value='aqua' {% if i['data']['color_name']=='aqua' %}
                                                        selected {% endif %}>Màu xanh nước biển</option>
                                                </select>
                                            </td><input name="color_order" value='{{loop.index-1}}'
                                                style="display: none;" />
                                        </tr>
                                        {% endif %}

                                        {% if i['data'].get('profile') != None %}
                                        <tr id='action{{loop.index-1}}'>
                                            <td width='30%'>Chọn chế độ</td>
                                            <td width="70%">
                                                <select name="profile" class="form-control">
                                                    <option value='energize' {% if i['data']['profile']=='energize' %}
                                                        selected {% endif %}>Chế độ sinh nhật</option>
                                                    <option value='relax' {% if i['data']['profile']=='relax' %}
                                                        selected {% endif %}>
                                                        Chế độ nghỉ ngơi</option>
                                                    <option value='reading' {% if i['data']['profile']=='reading' %}
                                                        selected {% endif %}>Chế độ nghe nhạc</option>
                                                    <option value='concentrate' {% if
                                                        i['data']['profile']=='concentrate' %} selected {% endif %}>
                                                        Chế độ vui nhộn</option>
                                                </select>
                                            </td>
                                            <input name="profile_order" value='{{loop.index-1}}'
                                                style="display: none;" />
                                        </tr>
                                        {% endif %}
                                        {% endif %}

                                        {% if i.get('delay') == None %}
                                        <tr id="block_action_{{loop.index-1}}">
                                            <td width='30%' id='action_id_{{loop.index-1}}'>Chọn thiết bị thực hiện</td>
                                            <td width="70%">
                                                <select name='entity' class='form-control selectpicker'
                                                    data-dropup-auto="false" data-size="7" data-width="100%"
                                                    data-live-search="true" id='action_{{loop.index-1}}'
                                                    onchange='remove_note({{loop.index-1}})' required>
                                                    <option selected>{{i['data']['entity_id']}}</option>
                                                </select>
                                            </td>
                                        </tr>
                                        {% endif %}

                                    </table>
                                </td>
                                <td id='func_{{loop.index-1}}'>
                                    <table>
                                        <tr>
                                            <td>
                                                <button id='delete_action_{{loop.index-1}}' type="button" value="Xóa"
                                                    class="btn btn-primary active"
                                                    onclick="deleteAction({{loop.index-1}})">Xoá</button>
                                            </td>
                                        </tr>
                                        <tr id='add_change_pos_btn{{loop.index-1}}'></tr>
                                    </table>
                                </td>
                            </tr>
                            {%endfor%}
                            <tr class="add_action"></tr>
                            <tr>
                                <td><button type="button" class="btn" style="background-color: #e0dbcd"
                                        onclick="addAction()">Thêm hành động</button></td>
                            </tr>
                        </table>
                        <input id='del_act' type="text" name='del_act' style="display: none;">

                        <input id='submit' type='submit' value='Lưu' class="btn btn-primary">
                    </form>
                </div>
            </div>
        </section>
        {%block content%}
        {%include 'head_foot/footer.html' %}
        {%endblock%}
    </body>

</html>
<script>
    len_act = {{ scripts['sequence'] | tojson }}.length;
    function check_action() {
        for (var i = 0; i < len_act; i++) {
            var select_section = document.getElementById('action_' + i);
            if ($('#action_' + i).val() == '') {
                $('#block_' + i).after("<tr id='note_" + i + "' class='note_" + i + "'><td colspan='2' style='color: red;'>Thiết bị thực hiện này có thể đã không còn hỗ trợ. Hãy chọn thiết bị mới.</td></tr>");

                change_device(i);
            }
            else
                change_device(i);
        }
    }

    function remove_note(dem_action) {
        if ($('#note_' + dem_action).text() != '') {
            $('#note_' + dem_action).remove();
            idx = 0;
            for (var i = 0; i < dem_action; i++) {
                if ($('#hanhdong_' + i).val() == 'delay') {
                    idx++;
                }
                else
                    idx += 2;
            }
            $('#bs-select-' + (idx + 2) + '-0').remove();
        }
    }


    // thêm hành động
    let dem_action = {{ len_dict| tojson}} + 1;
    var max_action = {{ len_dict| tojson}} + 1;
    function addAction() {
        string = add_action_type_script(dem_action);
        dem_action++;
        max_action++;
        $(".add_action").replaceWith(string);
        $(function () {
            $('.selectpicker').selectpicker();
        });
    }

    function show_change_pos_btn(dem_action) {
        position = $('#entity_action_id_' + dem_action).index();
        show_script_pos(position, dem_action);
    }


    list_entitys = {{ list_entitys | tojson }};

    function changeService(dem_action) {
        $(submit).show();
    }


    function addActionContent(dem_action, text_of_option) {
        $('#block_action_' + dem_action).show();
        hanhdong = document.getElementById('hanhdong_' + dem_action);
        var idx_action = 'entity_action_id_' + dem_action;
        var action_selected = hanhdong.value.split('.')[0];
        var exec_selected = hanhdong.value.split('.')[1];
        var select_section = document.getElementById('action_' + dem_action);
        $('#action_' + (dem_action))
            .find('option')
            .remove()
            .end()
            .append('<option disabled selected value="whatever"> -- Chọn 1 thiết bị -- </option>')
            .val('whatever')
            ;
        var entities = [];
        addActionContent_hanhdongValue_typeAutomation(dem_action, text_of_option);
        entities = addActionContent_option_typeAutomation2(entities, action_selected, select_section, exec_selected);

        for (var i = 0; i < entities.length; i++) {
            var custom_option = document.createElement("option");
            var t = document.createTextNode(entities[i]);
            custom_option.appendChild(t);
            select_section.appendChild(custom_option);
            $(select_section).selectpicker("refresh");
        }
    }


    function deleteAction(dem_action) {
        delete_action(dem_action);
    }

</script>
